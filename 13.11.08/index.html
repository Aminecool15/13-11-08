<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Souffle tes bougies ðŸŽ‚</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        text-align: center;
        font-family: 'Pixelify Sans', sans-serif;
        background-color: #fff;
      }

      #mainTitle {
        font-size: 32px;
        margin-bottom: 8px;
      }

      #subTitle {
        font-size: 18px;
        color: #555;
        margin-bottom: 20px;
      }

      #startBtn {
        background-color: #f472b6;
        color: white;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
      }

      #startBtn:hover {
        transform: scale(1.05);
        background-color: #ec4899;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="birthdayText"></div>
      <button id="startBtn">Activer le micro ðŸŽ¤</button>
      <div class="cake-container">
        <div class="cake" id="cake"></div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const name = params.get("name") || "Sima";
      let candleCount = parseInt(params.get("candles")) || 4;
      candleCount = Math.min(Math.max(candleCount, 1), 30);

      const birthdayText = document.getElementById("birthdayText");
      birthdayText.innerHTML = `
        <div id="mainTitle">Joyeux anniversaire ${name} !</div>
        <div id="subTitle">Clique sur le bouton, puis souffle ðŸŽ‰</div>
      `;

      const cake = document.getElementById("cake");
      const colors = ["green-candle", "purple-candle", "blue-candle", "yellow-candle"];

      function createCandles(count) {
        cake.innerHTML = "";
        const candlesPerRow = 6;
        const shiftAmount = 4;
        for (let i = 0; i < count; i++) {
          const candle = document.createElement("div");
          candle.classList.add("candle", colors[Math.floor(Math.random() * colors.length)]);
          const row = Math.floor(i / candlesPerRow);
          const col = i % candlesPerRow;
          candle.style.position = "absolute";
          candle.style.top = `${10 + row * 3}px`;
          candle.style.left = `${(col + 1) * 5}px`;
          cake.appendChild(candle);
        }
      }
      createCandles(candleCount);

      function blowOutCandles() {
        const candles = document.querySelectorAll(".candle");
        candles.forEach((candle) => {
          const delay = Math.random() * 1000;
          setTimeout(() => {
            candle.classList.add("blown");
          }, delay);
        });
        const subTitle = document.getElementById("subTitle");
        subTitle.textContent = "Toutes les bougies sont Ã©teintes ðŸŽ‚";
      }

      async function startMicDetection() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const source = audioContext.createMediaStreamSource(stream);
          const analyser = audioContext.createAnalyser();
          analyser.fftSize = 512;
          source.connect(analyser);
          const dataArray = new Uint8Array(analyser.frequencyBinCount);

          let blown = false;

          function detectBlow() {
            analyser.getByteTimeDomainData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
              const v = (dataArray[i] - 128) / 128.0;
              sum += v * v;
            }
            const volume = Math.sqrt(sum / dataArray.length);

            if (volume > 0.05 && !blown) {
              blown = true;
              blowOutCandles();
            }

            requestAnimationFrame(detectBlow);
          }

          detectBlow();
        } catch (err) {
          alert("Micro non accessible : " + err.message);
        }
      }

      document.getElementById("startBtn").addEventListener("click", () => {
        document.getElementById("subTitle").textContent = "Souffle maintenant ðŸŽ¤";
        startMicDetection();
      });
    </script>
  </body>
</html>
